#!/bin/bash

function log() {
    echo "$(date) - $1" >> ${daemon_log}
}

function is_pid_stored() {
    if [ -e ${pidfile} ]; then
        return 0
    else
        return 1
    fi
}

function store_pid() {
    log "Store pid $1 to ${pidfile}"
    echo $1 > ${pidfile}
}

function get_pid() {
    cat ${pidfile}
}

function del_pid() {
    rm -f ${pidfile}
}

function wait_until_down() {
    
    if is_pid_stored; then
        pid=`get_pid`
        log "Waiting for '${pid}' to go down"    

        while ps -p ${pid} > /dev/null; do
            sleep 1
        done    

        del_pid
    fi
}

function start() {
    log "Starting..."

    if [[ ! -p ${command_fifo} ]]; then
	log "Creating fifo ${command_fifo}"
        mkfifo ${command_fifo}
    fi

    log "Starting server..."
    echo "Test" > ${instance_log}
    tail -f ${command_fifo} | ${executable} &> ${instance_log} &
    store_pid $!
    
    log "Started"
    wait_until_down
    
    log "Daemon process exit"
}

function stop() {
    
    log "Send stop command"
    echo "stop" > ${command_fifo}

    wait_until_down
    log "Stoped succesful"
}

function reload() {
    echo "reload" > ${command_fifo}
}
case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  reload)
    reload
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|reload}"
esac
