#!/bin/bash

function log() {
    echo "$(date) - $1" >> ${daemon_log}
}

function store_pid() {
    log "Store pid $1 to ${pidfile}"
    echo $1 > ${pidfile}
}

function get_pid() {
    cat ${pidfile}
}

function wait_until_down() {
    
    pid=`get_pid`
    log "Waiting for '${pid}' to go down"    

    while ps -p ${pid} > ${daemon_log}; do
        sleep 1
    done    
}

function start() {
    log "Starting..."

    if [[ ! -p ${command_fifo} ]]; then
	log "Creating fifo ${command_fifo}"
        mkfifo ${command_fifo}
    fi

    log "Starting server..."
    echo "Test" > ${instance_log}
    tail -f ${command_fifo} | ${executable} &> ${instance_log} &
    store_pid $!
    
    log "Started"
    wait_until_down
    
    log "Done"
}

function stop() {
    
    log "Send stop command"
    echo "stop" > ${command_fifo}

    wait_until_down
}

function reload() {
    echo "reload" > ${command_fifo}
}
case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  reload)
    reload
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|reload}"
esac
